{
    "variables": {
        "playbook": "igo",
        "isotime_reference" : "2006-01-02 15-04-05",
        "ami_name": "windows_2016_base",
        "account_ids": "",
        "vpc": "{{env `BUILD_VPC_ID`}}",
        "subnet": "{{env `BUILD_SUBNET_ID`}}",
        "aws_region": "{{env `AWS_REGION`}}",
        "aws_profile": "anexinet",
        "git_hash": ""
    },
    "builders": [
        {
            "vpc_id": "{{user `vpc`}}",
            "subnet_id": "{{user `subnet`}}",
            "type": "amazon-ebs",
            "region": "us-east-1",
            "instance_type": "t3.large",
            "profile": "{{ user `aws_profile`}}",
            "ami_users": "{{ user `account_ids`}}",
            "ami_name": "{{ user `ami_name` }} {{isotime (user `isotime_reference`) | clean_resource_name}}",
            "ami_description": "ami build for {{ user `ami_name` }} on {{isotime (user `isotime_reference`) }}",
            "user_data_file": "./scripts/SetUpWinRM.ps1",
            "associate_public_ip_address": true,
            "communicator": "winrm",
            "winrm_username": "Administrator",
            "winrm_use_ntlm" : true,
            "winrm_port": 5986,
            "winrm_use_ssl" : true,
            "winrm_insecure" : true,
            "source_ami_filter": {
                "filters": {
                    "virtualization-type": "hvm",
                    "name": "*Windows_Server-2016-English-Full-Base*",
                    "root-device-type": "ebs"
                },
                "owners": ["amazon"],
                "most_recent": true
            },
            "launch_block_device_mappings": [
                {
                    "device_name": "/dev/sda1",
                    "volume_size": "50",
                    "volume_type": "gp2",
                    "delete_on_termination": true
                },
                {
                    "device_name": "/dev/xvdb",
                    "volume_size": "50",
                    "volume_type": "gp2",
                    "delete_on_termination": true
                }
            ],
            "security_group_id": "sg-0adc027d021c3f5e1",
            "iam_instance_profile": "ec2_admin",
            "tags": {
                "Name": "{{ user `ami_name`}} {{isotime (user `isotime_reference`) }}",
                "Environment": "{{ user `environment`}}",
                "Terminate": "true-jkovolski",
                "GIT_HASH": "{{user `git_hash`}}"
            }
        }
    ],
    "provisioners": [
        {
            "type": "powershell",
            "inline": [
                "Get-Disk | Where partitionstyle -eq 'raw' | Initialize-Disk -PartitionStyle MBR -PassThru | New-Partition -AssignDriveLetter -UseMaximumSize | Format-Volume -FileSystem NTFS -NewFileSystemLabel \"disk2\" -Confirm:$false"
            ]
        },
        {
            "type": "windows-shell",
            "inline": [
                "md C:\\bootstrap"
            ]
        },
        {
            "type": "file",
            "source": "./scripts",
            "destination": "C:\\bootstrap"
        },
        {
            "type": "powershell",
            "scripts": [
                "./scripts/CreateServerAdminUser.ps1"
            ],
            "elevated_user": "Administrator",
            "elevated_password": "{{.WinRMPassword}}"
        },
        {
            "type": "powershell",
            "scripts": [
                "./scripts/SetDriveLetterMapping.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts": [
                "./scripts/ConfigureRemotingForAnsible.ps1"
            ]
        },
        {
            "type": "powershell",
            "inline": [
              "switch -Wildcard ($env:PACKER_BUILDER_TYPE) {",
              "  \"amazon*\" { $publicipv4 = Invoke-RestMethod -Method GET -Uri http://169.254.169.254/latest/meta-data/public-ipv4 }",
              "  Default { Throw \"Unknown PACKER_BUILDER_TYPE\" } }",
              "\"[{{build_name}}]\" | Out-File C:\\Windows\\Temp\\host -encoding ascii",
              "$publicipv4 | Out-File C:\\Windows\\Temp\\host -encoding ascii"
              ]
          },
          {
            "type": "file",
            "direction": "download",
            "source": "C:\\Windows\\Temp\\host",
            "destination": "playbook/{{build_name}}-host"
          },
        {
            "type": "shell-local",
            "inline": [
              "ansible-playbook -vvvv -i playbook/{{build_name}}-host --extra-vars \"ANSIBLE_ROLES_PATH=ansible/roles ansible_user=administrator ansible_password={{.WinRMPassword}} ansible_become_pass={{.WinRMPassword}} ansible_connection=winrm ansible_winrm_server_cert_validation=ignore\" ansible/playbooks/{{user `playbook`}}.yml"
            ]
          },
        {
            "type": "powershell",
            "inline": [
                "C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Scripts\\SendWindowsIsReady.ps1 -Schedule",
                "C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Scripts\\InitializeDisks.ps1 -Schedule",
                "C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Scripts\\InitializeInstance.ps1 -Schedule",
                "C:\\ProgramData\\Amazon\\EC2-Windows\\Launch\\Scripts\\SysprepInstance.ps1 -NoShutdown"
            ],
            "elevated_user": "Administrator",
            "elevated_password": "{{.WinRMPassword}}"
        }
    ],
    "post-processors": [
        {
            "type": "manifest"
        }
    ]
}